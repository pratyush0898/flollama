"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/context/AuthContext";
import { saveChatMessages, appendMessage } from "@/lib/chatService";
import { GridLoader } from "react-spinners";

export default function NewChatPage() {
  const { user, login } = useAuth();
  const [text, setText] = useState("");
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return login();

    const chatId = text.trim() || "New Chat";

    setLoading(true);

    try {
      await saveChatMessages(user.uid, chatId, []);
      if (text.trim()) {
        await appendMessage(user.uid, chatId, {
          role: "user",
          content: text.trim(),
        });
      }
      router.push(`/chat/${encodeURIComponent(chatId)}`);
    } catch (error) {
      console.error("Error creating chat:", error);
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <>
        <noscript>Loading</noscript>
        <div className="chat-page">
          <GridLoader color="var(--color-text)" size={24} />
        </div>
      </>
    );
  }

  return (
    <div className="chat-page gap-0">
      <div className="trademark mb-1 logicon">
        <svg
          width={72}
          viewBox="0 0 350 372"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill="currentColor"
            d="M200.292 21.9617C204.668 14.8856 209.486 8.42537 216.264 3.71487C218.477 2.17663 220.822 0.910415 223.689 0.878071C227.065 0.83999 229.51 2.27734 231.185 5.11187C232.866 7.95743 233.993 11.0314 234.664 14.2622C234.802 14.9255 234.962 15.5208 235.447 16.1712C238.826 10.8105 242.742 6.14244 247.956 2.71324C254.914 -1.86296 261.469 0.895218 263.051 8.99156C263.312 10.3257 263.411 11.648 263.461 12.9957C263.685 19.1262 262.305 25.0274 260.885 30.9126C259.584 36.302 258.232 41.6827 256.722 47.0161C256.135 49.0902 256.811 49.6505 258.735 49.9959C266.431 51.3779 273.664 53.9619 280.128 58.5147C284.708 61.7402 288.219 65.8706 290.782 70.7898C291.663 72.4797 292.845 73.5242 294.56 74.245C305.573 78.8739 316.684 83.2813 327.478 88.4148C332.529 90.8169 337.219 93.7702 340.944 98.045C345.514 103.291 347.204 109.43 346.453 116.271C346.325 117.441 346.727 118.364 347.081 119.405C350.15 128.446 350.047 137.278 343.719 144.899C341.081 148.078 338.184 151.103 335.421 154.22C328.739 161.76 319.549 164.315 310.051 165.941C303.913 166.992 297.725 167.624 291.48 167.54C290.475 167.526 289.47 167.649 288.466 168.337C289.265 175.614 290.075 182.934 290.872 190.256C291.679 197.678 292.542 205.096 293.256 212.527C294.148 221.804 295.006 231.085 295.695 240.378C296.093 245.742 296.2 251.133 296.293 256.514C296.329 258.616 296.863 259.254 299.132 258.924C307.495 257.704 315.112 254.412 322.692 250.942C326.019 249.419 329.37 249.58 330.948 251.465C333.13 254.071 333.096 256.978 331.719 259.985C325.866 272.773 316.549 282.508 305.014 290.271C301.802 292.433 298.519 294.509 294.907 295.956C293.458 296.536 292.941 297.721 292.514 299.004C288.237 311.866 281.628 323.4 272.865 333.726C256.567 352.93 236.154 365.186 211.29 369.441C190.472 373.004 170.842 368.866 152.331 358.918C137.059 350.711 124.57 339.09 112.791 326.632C99.9812 313.084 89.2948 297.795 77.6181 283.317C71.688 275.965 65.4553 268.863 57.8312 263.204C43.4485 252.528 27.8351 249.896 10.9278 256.468C6.0819 258.352 2.3853 256.543 1.20966 251.813C0.592507 249.329 1.76118 247.377 3.12623 245.53C7.11335 240.134 12.0812 235.712 17.2927 231.56C26.5792 224.161 36.8221 218.722 48.6508 216.688C65.1922 213.844 80.7774 216.611 95.3683 224.88C106.858 231.391 116.364 240.288 125.235 249.932C138.23 264.059 150.035 279.248 163.665 292.811C174.399 303.492 185.888 313.171 199.348 320.29C204.938 323.246 210.779 325.611 216.868 327.355C218.074 327.7 219.256 328.18 220.385 328.73C223.907 330.443 225.319 333.337 224.246 336.483C222.932 340.335 219.948 342.046 215.911 341.068C206.352 338.753 197.414 334.887 188.964 329.898C173.385 320.701 160.009 308.832 147.683 295.694C138.636 286.05 130.322 275.766 121.524 265.905C113.165 256.536 104.861 247.01 94.1971 240.2C72.6607 226.448 50.7726 226.367 28.8517 239.542C32.0848 240.141 35.3633 239.781 38.6195 240.238C50.372 241.889 60.2193 247.393 69.1718 254.837C78.7603 262.811 86.5609 272.422 94.1297 282.227C105.038 296.358 115.753 310.655 128.332 323.382C141.068 336.268 155.242 347.066 172.724 352.844C187.006 357.563 201.448 357.931 215.959 354.183C243.207 347.147 262.549 330.269 275.699 305.791C276.176 304.903 276.569 303.969 276.971 303.043C277.062 302.833 277.024 302.567 277.064 302.125C274.395 301.626 271.913 302.597 269.417 302.959C255.86 304.925 242.628 303.463 229.545 299.666C212.314 294.665 197.503 285.401 183.825 274.076C170.677 263.19 159.06 250.803 148.025 237.823C136.849 224.676 125.861 211.324 112.274 200.494C103.195 193.257 93.13 188.004 81.5502 186.032C72.5286 184.495 63.6374 184.795 54.9572 187.971C54.3251 188.202 53.684 188.408 53.0495 188.633C50.2986 189.607 47.7257 189.542 45.6518 187.19C43.9762 185.29 43.9342 182.301 45.6891 179.4C49.798 172.608 55.4201 167.153 61.5431 162.237C71.64 154.131 83.0683 148.894 95.9075 146.809C108.048 144.838 119.88 146.317 131.483 149.99C147.835 155.167 161.331 164.907 173.507 176.696C174.156 177.324 174.636 178.183 175.659 178.393C176.614 177.709 176.214 176.698 176.216 175.849C176.249 165.322 176.186 154.795 176.257 144.269C176.347 130.897 176.688 117.528 178.801 104.29C180.898 91.1577 184.246 78.4369 192 67.3212C193.013 65.8701 193.156 64.4015 192.851 62.7761C191.903 57.7233 191.431 52.6648 191.843 47.4953C192.574 38.3334 195.396 29.9138 200.292 21.9617ZM249.39 159.264C248.883 158.702 248.335 158.171 247.874 157.573C245.635 154.665 245.414 151.761 247.249 149.75C248.891 147.951 252.013 147.834 254.9 149.481C257.171 150.776 259.483 151.92 262.064 152.535C270.296 154.495 278.588 155.141 287.062 154.669C295.975 154.173 304.822 153.373 313.537 151.445C317.185 150.638 320.832 149.684 324.026 147.042C320.162 146.582 316.569 146.271 313.018 145.699C309.536 145.138 306.036 144.478 303.004 142.482C300.481 140.821 299.399 137.814 300.424 135.496C301.322 133.467 303.827 132.447 306.723 133.055C309.436 133.624 312.12 134.327 314.824 134.94C320.942 136.328 327.061 137.068 333.275 135.37C334.971 134.907 335.866 134.016 336.242 132.376C336.771 130.062 335.955 127.884 335.702 125.644C335.466 123.556 334.517 122.81 332.383 122.936C328.691 123.156 324.973 123.224 321.409 121.872C318.497 120.767 316.279 118.995 315.48 115.834C314.494 111.93 317.406 108.851 321.333 109.723C322.719 110.031 324.034 110.649 325.386 111.114C328.221 112.09 330.737 111.41 333.442 109.711C332.588 108.717 331.968 107.949 331.3 107.224C328.03 103.674 323.798 101.547 319.552 99.5076C310.296 95.0623 300.861 91.0116 291.33 87.1951C286.171 85.1291 281.968 82.1192 279.133 77.1505C276.441 72.4308 272.367 69.0777 267.4 66.779C258.597 62.7048 249.262 62.1458 239.773 62.2387C236.811 62.2677 234.755 62.7284 233.66 66.027C232.514 69.4789 228.77 70.5641 224.996 69.1676C222.105 68.0976 221.136 65.7688 222.055 62.0947C222.197 61.5235 222.341 60.9525 222.488 60.3823C225.378 49.1717 226.176 37.8413 224.201 26.4009C223.653 23.2294 223.065 20 221.254 16.8739C218.269 19.3594 216.051 22.0868 214.082 25.0026C206.201 36.6751 202.667 49.3381 206.347 63.2617C207.251 66.6843 206.705 69.0572 204.74 71.7801C197.641 81.6166 194.217 92.8921 192.153 104.708C190.701 113.02 190.408 121.397 190.01 129.789C189.479 140.986 189.834 152.18 189.793 163.374C189.763 171.608 189.82 179.848 188.241 187.971C187.837 190.05 188.192 191.609 189.608 193.228C199.251 204.251 208.602 215.523 219.214 225.678C228.447 234.514 238.294 242.46 249.572 248.55C259.268 253.787 269.387 257.741 280.433 259.026C282.331 259.247 283.097 258.73 283.001 256.786C282.863 254.012 282.989 251.221 282.773 248.455C281.738 235.222 280.853 221.98 279.425 208.775C278.079 196.331 276.473 183.918 275.18 171.471C274.877 168.562 274.08 166.902 270.823 167.364C270.031 167.476 269.172 167.112 268.343 166.975C261.567 165.859 254.941 164.368 249.39 159.264ZM243.801 289.066C268.143 293.006 289.557 286.954 308.366 270.103C291.789 274.033 275.932 273.517 260.285 268.012C248.338 263.808 237.523 257.564 227.365 250.097C210.952 238.032 197.444 223.032 184.318 207.625C172.22 193.423 159.575 179.755 143.219 170.257C124.567 159.426 105.008 156.321 84.4106 164.166C79.591 166.001 74.9888 168.359 70.5083 171.857C80.2523 171.959 89.2453 173.218 97.9374 176.561C113.179 182.422 125.274 192.636 136.455 204.092C147.933 215.851 157.851 228.993 168.923 241.119C182.625 256.125 197.368 269.815 215.661 279.179C224.467 283.687 233.593 287.248 243.801 289.066ZM240.036 48.4907C243.813 48.3814 243.792 48.3765 244.649 44.6205C245.897 39.1517 247.195 33.6941 248.443 28.2251C249.114 25.2834 249.725 22.3281 250.364 19.3789C245.435 23.7728 241.461 28.6877 238.599 34.4361C238.381 34.8732 238.283 35.4013 238.252 35.8949C238.025 39.4888 237.875 43.0882 237.603 46.6784C237.481 48.2877 238.072 48.8624 240.036 48.4907Z"
          />
          <path
            fill="currentColor"
            d="M266.626 95.7741C260.651 102.196 249.602 102.493 243.492 96.5342C239.838 92.9708 240.319 88.6492 244.429 85.6066C249.791 81.6373 261.448 81.7877 265.515 85.9834C268.531 89.0939 269.076 91.872 266.626 95.7741Z"
          />
        </svg>
        <div className="logo">flollama</div>
      </div>

      <form className="newchat-input-box w-full" onSubmit={handleSubmit}>
        <input
          value={text}
          onChange={(e) => setText(e.target.value)}
          type="text"
          placeholder="Type your messageâ€¦"
          className="newchat-input body w-full"
        />
        <button type="submit" className="send-button">
          <svg
            className="input-icon"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
          >
            <path d="M1.513 1.96a1.374 1.374 0 0 1 1.499-.21l19.335 9.215a1.147 1.147 0 0 1 0 2.07L3.012 22.25a1.374 1.374 0 0 1-1.947-1.46L2.49 12 1.065 3.21a1.375 1.375 0 0 1 .448-1.25Zm2.375 10.79-1.304 8.042L21.031 12 2.584 3.208l1.304 8.042h7.362a.75.75 0 0 1 0 1.5Z"></path>
          </svg>
        </button>
      </form>
    </div>
  );
}
